---
version: "3.6"
services:
  envoy-frontend:
    image: envoyproxy/envoy:v1.13.1
    networks:
      -  homelab
    hostname: envoy
    volumes:
      - ./configs/envoy/frontend.yaml:/etc/envoy/envoy.yaml
      - ./assets/envoy/mikemay-io.crt:/etc/mikemay-io.crt
      - ./assets/envoy/mikemay-io.key:/etc/mikemay-io.key
    expose:
      - "80"
      - "443"
      - "8001"
      - "9901"
    ports:
      - "80:80"
      - "443:443"
      - "8001:8001"
      - "9901:9901"

  postgres:
    image: timescale/pg_prometheus:latest-pg11
    networks:
      -  homelab
    hostname: postgres
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: postgres
    volumes:
      - "/mnt/data/postgres/db:/var/lib/postgresql/data"
    expose:
      - "5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5
    
  keycloak:
    image: jboss/keycloak:9.0.2
    networks:
      - homelab
    hostname: keycloak
    depends_on: 
      - postgres
    environment:
      KEYCLOAK_IMPORT: /tmp/realm-mikemay-io.json
      SERVICE_NAME: keycloak
      KEYCLOAK_FRONTEND_URL: https://sso.mikemay.io/auth
      KEYCLOAK_USER: keycloak
      KEYCLOAK_PASSWORD: keycloak
      DB_VENDOR: postgres
      DB_ADDR: postgres
      DB_PORT: 5432
      DB_DATABASE: postgres
      DB_USER: postgres
      DB_PASSWORD: postgres
    volumes:
      - "./assets/keycloak/realm-mikemay-io.json:/tmp/realm-mikemay-io.json"
    expose:
      - "8080"
  
  prometheus:
    depends_on: 
      - postgres
    image: prom/prometheus
    networks:
      - homelab
    ports:
        - "9090:9090"
    volumes:
        - "./configs/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml"

  prometheus_postgresql_adapter:
    depends_on: 
      - postgres
    image: timescale/prometheus-postgresql-adapter:latest
    networks:
      - homelab
    ports: 
      - "9201:9201"
    command: ['-pg-host=postgres', '-pg-password=password', '-pg-prometheus-log-samples']

  telegraf:
    depends_on: 
      - prometheus
    image: telegraf:alpine
    networks: 
      - homelab
    volumes:
      - "./configs/telegraf/telegraf.conf:/etc/telegraf/telegraf.conf:ro"
      - "/proc:/host/proc:ro"
      - "/sys:/host/sys:ro"
      - "/etc:/host/etc:ro"
      - "/var:/host/var:ro"
      - "/run:/host/run:ro"
      - "/var/run/docker.sock:/var/run/docker.sock"
    environment:
      HOST_PROC: /host/proc
      HOST_SYS: /host/sys
      HOST_ETC: /host/etc 
      HOST_VAR: /host/var
      HOST_RUN: /host/run
      HOST_MOUNT_PREFIX: /host

  grafana:
    image: grafana/grafana
    networks: 
      - homelab
    expose: 
      - "3000"
    ports:
      - "3000:3000"
    volumes:
      - "./configs/grafana/grafana.ini:/etc/grafana/grafana.ini"
      - "./assets/grafana/dashboards:/var/lib/grafana/dashboards"
      - "./assets/grafana/provisioning:/etc/grafana/provisioning"
      - "./assets/envoy/mikemay-io.crt:/etc/ssl/certs/ca-certificates.crt"
    environment: 
      GF_INSTALL_PLUGINS: grafana-clock-panel,grafana-simple-json-datasource,grafana-piechart-panel,monasca-datasource,grafana-kubernetes-app
  
networks:
  homelab:
    driver: bridge